<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Portal - Patil Hospital</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f4f7f6;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-container">
            <h2 style="text-align:center; color:var(--primary-blue); margin-bottom:20px;">Doctor Login</h2>
            <div id="debug-status"
                style="text-align:center; color:#666; font-size:0.8rem; margin-bottom:10px; min-height: 1.2em;"></div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Select Your Name</label>
                    <select id="login-doc-select" class="form-select" required>
                        <option value="">-- Choose Doctor --</option>
                        <!-- Loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" class="form-select" placeholder="Enter Password"
                        required>
                    <small style="color:#888; display:block; margin-top:5px;">(Hint: Use your Doctor ID e.g.
                        'admin1')</small>
                </div>
                <button type="submit" class="btn-primary" style="width:100%;">Login</button>
            </form>
            <p style="text-align:center; margin-top:20px;">
                <a href="index.html" style="color:#666; font-size:0.9rem;">Back to Hospital Home</a>
            </p>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="hidden">
        <!-- NAV -->
        <nav class="sticky-nav" style="background: #2c3e50; color:white;">
            <div class="nav-brand">
                <div class="logo-icon-sm" style="color:white;">+</div>
                <div class="brand-text">
                    <h2 style="color:white;">DOCTOR PORTAL</h2>
                    <span style="color:#bdc3c7;" id="nav-doc-name">--</span>
                </div>
            </div>
            <div class="nav-links">
                <button class="nav-btn" style="color:white;" onclick="logout()">Logout</button>
            </div>
        </nav>

        <div class="content-area section-padding">

            <!-- CONTROL PANEL -->
            <h2 style="margin-bottom:20px;">Clinic Controls (<span id="ctrl-dept-name">--</span>)</h2>
            <div class="control-panel">
                <!-- Status Control -->
                <div class="control-card">
                    <h4>My Availability</h4>
                    <select id="doc-status-select" class="form-select" style="margin-top:10px;">
                        <option value="Available">Available</option>
                        <option value="Busy">Busy (In Consultation)</option>
                        <option value="Off">Off Duty</option>
                    </select>
                    <button class="btn-primary" style="margin-top:10px; width:100%;" onclick="updateStatus()">Update
                        Status</button>
                </div>

                <!-- Queue Control -->
                <div class="control-card">
                    <h4>Live Queue Control</h4>
                    <div style="display:flex; justify-content:space-between; margin-top:10px;">
                        <div>
                            <label style="font-size:0.8rem;">Current Token</label>
                            <input type="number" id="ctrl-queue-current" class="form-select" style="width:80px;">
                        </div>
                        <div>
                            <label style="font-size:0.8rem;">Total Tokens</label>
                            <input type="number" id="ctrl-queue-total" class="form-select" style="width:80px;">
                        </div>
                    </div>
                    <button class="btn-primary" style="margin-top:10px; width:100%;" onclick="updateQueue()">Update
                        Queue</button>
                </div>
            </div>

            <!-- APPOINTMENTS LIST -->
            <!-- APPOINTMENTS VIEW -->
            <div id="appointments-view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>My Appointments</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="nav-btn" onclick="toggleView('messages')"
                            style="border:1px solid #ccc; background: white; color: #333;">ðŸ“© Messages</button>
                        <button class="btn-primary" onclick="loadAppointments('today')"
                            style="background:var(--accent-green);">ðŸ“… Today's Only</button>
                        <button class="nav-btn" onclick="loadAppointments('all')" style="border:1px solid #ccc;">Show
                            All</button>
                    </div>
                </div>

                <div class="booking-card" style="max-width:100%;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:var(--bg-light); text-align:left;">
                                <th style="padding:15px;">ID</th>
                                <th style="padding:15px;">Patient</th>
                                <th style="padding:15px;">Date</th>
                                <th style="padding:15px;">Status</th>
                                <th style="padding:15px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="doc-apt-list">
                            <!-- Rows loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- MESSAGES VIEW -->
            <div id="messages-view" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>Patient Messages</h2>
                    <button class="nav-btn" onclick="toggleView('appointments')">Back to Appointments</button>
                </div>
                <div class="booking-card" style="max-width:100%;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:var(--bg-light); text-align:left;">
                                <th style="padding:15px;">Date</th>
                                <th style="padding:15px;">Name</th>
                                <th style="padding:15px;">Subject</th>
                                <th style="padding:15px;">Message</th>
                            </tr>
                        </thead>
                        <tbody id="msg-list">
                            <!-- Loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="overlay hidden">
        <div class="booking-card" style="margin: auto; max-width: 600px; position:relative;">
            <button onclick="closeModal('report-modal')" class="close-btn"
                style="position:absolute; right:20px; top:20px;">&times;</button>
            <h3>Write Medical Report</h3>
            <p id="report-patient-name" style="color:var(--text-muted); margin-bottom:20px;">Patient: --</p>

            <form id="report-form" onsubmit="submitDoctorReport(event)">
                <input type="hidden" id="report-apt-id">
                <div class="form-group">
                    <label>Symptoms</label>
                    <input type="text" id="report-symptoms" placeholder="e.g. Fever, Cough, Headache">
                </div>
                <div class="form-group">
                    <label>Diagnosis</label>
                    <input type="text" id="report-diagnosis" required placeholder="Viral Fever, etc.">
                </div>
                <div class="form-group">
                    <label>Prescribed Medicines</label>
                    <textarea id="report-meds" rows="3" required placeholder="Paracetamol 500mg..."></textarea>
                </div>
                <div class="form-group">
                    <label>Upload Reports (Optional)</label>
                    <input type="file" id="report-file" class="form-select">
                    <small style="color:#666;">(Feature: File will be tagged to this report)</small>
                </div>
                <div class="form-group">
                    <label>Doctor's Notes</label>
                    <textarea id="report-notes" rows="2" placeholder="Additional observations..."></textarea>
                </div>
                <div class="form-group">
                    <label>Follow-up Date</label>
                    <input type="date" id="report-followup" class="form-select">
                </div>
                <button type="submit" class="btn-primary">Save & Generate Report</button>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="overlay hidden">
        <div class="booking-card"
            style="margin: auto; max-width: 700px; position:relative; max-height:80vh; overflow-y:auto;">
            <button onclick="closeModal('history-modal')" class="close-btn"
                style="position:absolute; right:20px; top:20px;">&times;</button>
            <h3>Patient Medical History</h3>
            <p id="history-patient-name" style="color:var(--text-muted); margin-bottom:20px;">Patient: --</p>

            <div id="history-list">
                Loading...
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        const API_URL = '/api';
        let currentDoc = null;

        function toggleView(view) {
            if (view === 'messages') {
                document.getElementById('appointments-view').classList.add('hidden');
                document.getElementById('messages-view').classList.remove('hidden');
                loadMessages();
            } else {
                document.getElementById('appointments-view').classList.remove('hidden');
                document.getElementById('messages-view').classList.add('hidden');
            }
        }

        async function loadMessages() {
            const list = document.getElementById('msg-list');
            list.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

            try {
                const res = await fetch(`${API_URL}/doctor/messages`);
                const msgs = await res.json();

                list.innerHTML = '';
                if (msgs.length === 0) {
                    list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#666;">No messages found.</td></tr>';
                    return;
                }

                msgs.forEach(m => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #eee';
                    tr.innerHTML = `
                        <td style="padding:15px; color:#666;">${new Date(m.created_at).toLocaleDateString()}</td>
                        <td style="padding:15px; font-weight:600;">${m.name}</td>
                        <td style="padding:15px;">${m.subject}</td>
                        <td style="padding:15px; color:#444;">${m.message}</td>
                    `;
                    list.appendChild(tr);
                });

            } catch (e) {
                console.error(e);
                list.innerHTML = '<tr><td colspan="4" style="color:red;">Failed to load messages</td></tr>';
            }
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function logout() {
            localStorage.removeItem('doctor_user');
            location.reload();
        }

        async function init() {
            const debugEl = document.getElementById('debug-status');
            // Removed "Checking session..." message to avoid flicker

            // Check for persistent login
            const savedUser = localStorage.getItem('doctor_user');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    debugEl.textContent = "Welcome back, " + (user.name || 'Doctor');
                    console.log("Auto-login success:", user);

                    // Validate User Object
                    if (user.name && user.department) {
                        finishLogin(user);
                    } else {
                        throw new Error("Invalid User Data");
                    }
                } catch (e) {
                    debugEl.textContent = "";
                    console.error("Auto-login failed:", e);
                    localStorage.removeItem('doctor_user');
                }
            } else {
                debugEl.textContent = ""; // Keep clean if no session
                console.log("No saved user found.");
            }

            // Load Doctor List for Dropdown
            try {
                const res = await fetch(`${API_URL}/doctors`);
                const doctors = await res.json();
                const select = document.getElementById('login-doc-select');

                doctors.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.mobile; // Using mobile as ID for simplicity
                    opt.textContent = `${doc.name} (${doc.department})`;
                    select.appendChild(opt);
                });
            } catch (e) { console.error("Init Error", e); }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const mobile = document.getElementById('login-doc-select').value;
            const password = document.getElementById('login-password').value;

            if (!mobile) return showToast('Select a doctor', 'error');

            // Hardcoded password verification (simplified)
            // Ideally backend should verify
            // For this demo, assuming password matches data or just generic 'admin'
            // But we seeded specific passwords like 'admin1', 'admin2'
            // Let's call login API

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mobile: mobile }) // Sending selected mobile
                });

                const data = await res.json();

                if (data.status === 'success' || data.role) {
                    const user = data.user || data;

                    if (user.role === 'doctor') {
                        // Password check
                        if (password === mobile) {
                            localStorage.setItem('doctor_user', JSON.stringify(user)); // SAVE SESSION
                            finishLogin(user);
                        } else {
                            showToast('Invalid Password (Use admin1, admin2...)', 'error');
                        }
                    } else {
                        showToast('Not a doctor account', 'error');
                    }
                } else {
                    showToast('Login Failed', 'error');
                }

            } catch (e) { console.error(e); showToast('Login Failed', 'error'); }
        }

        function finishLogin(user) {
            currentDoc = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');

            // UI Update
            document.getElementById('nav-doc-name').textContent = user.name;
            document.getElementById('ctrl-dept-name').textContent = user.department;

            // Set Controls
            document.getElementById('doc-status-select').value = user.status || 'Available';
            document.getElementById('ctrl-queue-current').value = user.queue_current || 0;
            document.getElementById('ctrl-queue-total').value = user.queue_total || 0;

            loadAppointments();
        }

        // Removed duplicate logout function

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        async function loadAppointments(filter = 'all') {
            // In a real app, we'd filter by doctor ID. 
            // Reuse existing endpoint but ideally add ?doc_id=...
            // For now fetching all and filtering here for simplicity or creating new endpoint
            const res = await fetch(`${API_URL}/doctor/appointments`);
            const allApts = await res.json();

            // Filter
            // Note: appointments table doesn't have doctor_id yet, only dept. 
            // Matching by Dept
            let myApts = allApts.filter(a => a.dept === currentDoc.department);

            // Filter by Date (Today)
            if (filter === 'today') {
                const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD
                myApts = myApts.filter(a => a.date === today);
            }

            const list = document.getElementById('doc-apt-list');
            list.innerHTML = '';

            myApts.forEach(apt => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #eee';
                let actionBtn = '';

                if (apt.status === 'Completed') {
                    actionBtn = `<span style="color:green; font-weight:bold; margin-right:10px;">Completed</span> 
                                  <button class="nav-btn" style="padding:2px 5px; font-size:0.75rem; color:#dc3545;" onclick="deleteAppointment(${apt.id})">Remove</button>`;
                } else if (apt.status === 'Confirmed') {
                    actionBtn = `<span style="color:var(--primary-blue); font-weight:bold; margin-right:5px;">Confirmed</span>
                                  <button class="btn-primary" style="padding:5px 15px; font-size:0.8rem;" onclick="openReportModal(${apt.id}, '${apt.patient_name || 'Walk-in Patient'}')">Write Report</button>`;
                } else {
                    // Scheduled / Pending
                    actionBtn = `<button class="btn-primary" style="padding:5px 10px; font-size:0.8rem; background:var(--accent-green); margin-right:5px;" onclick="confirmAppointment(${apt.id})">âœ… Accept Request</button>
                                  <button class="nav-btn" style="padding:5px 10px; font-size:0.8rem; color:#dc3545;" onclick="deleteAppointment(${apt.id})">âœ• Reject</button>`;
                }

                // Always show history
                actionBtn += `<button class="nav-btn" style="margin-left:5px; font-size:0.8rem;" onclick="viewHistory('${apt.user_mobile}', '${apt.patient_name}')">ðŸ“œ History</button>`;

                tr.innerHTML = `
                    <td style="padding:15px;">#${apt.id}</td>
                    <td style="padding:15px;">
                        <div style="font-weight:600;">${apt.patient_name || 'Guest User'}</div>
                        <div style="font-size:0.85rem; color:#666;">Age: ${apt.patient_age || '--'}</div>
                    </td>
                    <td style="padding:15px;">${apt.date}</td>
                    <td style="padding:15px;">${apt.status}</td>
                    <td style="padding:15px;">${actionBtn}</td>
                `;
                list.appendChild(tr);
            });
        }

        async function deleteAppointment(id) {
            if (!confirm("Are you sure you want to remove this appointment?")) return;

            await fetch(`${API_URL}/appointments/${id}`, { method: 'DELETE' });
            showToast('Appointment Removed', 'success');
            loadAppointments(); // Refresh list
        }

        async function confirmAppointment(id) {
            await fetch(`${API_URL}/appointments/${id}/confirm`, { method: 'POST' });
            showToast('Appointment Confirmed!', 'success');
            loadAppointments();
        }

        async function cancelAppointment(id) {
            if (!confirm("Are you sure you want to cancel this appointment? It will remain in history.")) return;
            await fetch(`${API_URL}/appointments/${id}/cancel`, { method: 'POST' });
            showToast('Appointment Cancelled', 'info');
            loadAppointments();
        }

        async function viewHistory(mobile, name) {
            if (!mobile || mobile === 'undefined') return showToast('No history available for guest users.', 'error');

            document.getElementById('history-patient-name').textContent = `Patient: ${name}`;
            const list = document.getElementById('history-list');
            list.innerHTML = 'Loading history...';
            document.getElementById('history-modal').classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}/doctor/patient_history/${mobile}`);
                const history = await res.json();

                if (history.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#666;">No previous medical records found.</p>';
                    return;
                }

                let html = '';
                history.forEach(rec => {
                    const hasReport = rec.diagnosis ? true : false;
                    html += `
                        <div style="background:#f8f9fa; border-left:4px solid ${hasReport ? 'var(--accent-green)' : '#ccc'}; padding:15px; margin-bottom:15px; border-radius:5px;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>Date: ${rec.date}</strong>
                                <span style="font-size:0.85rem; color:#555;">${rec.dept}</span>
                            </div>
                            <div style="margin-top:5px;">
                                ${hasReport ? `
                                    <div style="font-weight:600; color:#333;">Dx: ${rec.diagnosis}</div>
                                    <div style="font-size:0.9rem; margin-top:3px;">Rx: ${rec.medicines}</div>
                                    ${rec.file_path ? `<div style="margin-top:5px;"><a href="/uploads/${rec.file_path}" target="_blank" style="color:var(--primary-blue); text-decoration:underline;">ðŸ“Ž View Attachment</a></div>` : ''}
                                ` : '<span style="color:#888; font-style:italic;">No detailed report</span>'}
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;

            } catch (e) { console.error(e); list.innerHTML = 'Error loading history.'; }
        }

        async function updateStatus() {
            const status = document.getElementById('doc-status-select').value;
            await fetch(`${API_URL}/doctor/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: currentDoc.id, status: status })
            });
            showToast('Availability Updated', 'success');
        }

        async function updateQueue() {
            const current = document.getElementById('ctrl-queue-current').value;
            const total = document.getElementById('ctrl-queue-total').value;
            await fetch(`${API_URL}/doctor/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: currentDoc.id, queue_current: current, queue_total: total })
            });
            showToast('Queue Updated', 'success');
        }

        window.openReportModal = function (aptId, patientName) {
            document.getElementById('report-apt-id').value = aptId;
            document.getElementById('report-patient-name').textContent = `Patient: ${patientName}`;
            document.getElementById('report-form').reset();
            document.getElementById('report-apt-id').value = aptId;
            document.getElementById('report-patient-name').textContent = `Patient: ${patientName}`;
            document.getElementById('report-form').reset();
            // Fetch existing report if any to prefill? Maybe later.
            document.getElementById('report-modal').classList.remove('hidden');
        };

        async function submitDoctorReport(e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append('appointment_id', document.getElementById('report-apt-id').value);
            formData.append('diagnosis', document.getElementById('report-diagnosis').value);
            formData.append('symptoms', document.getElementById('report-symptoms').value);
            formData.append('medicines', document.getElementById('report-meds').value);
            formData.append('notes', document.getElementById('report-notes').value);
            formData.append('follow_up_date', document.getElementById('report-followup').value);

            const fileInput = document.getElementById('report-file');
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }

            try {
                const res = await fetch(`${API_URL}/doctor/report`, {
                    method: 'POST',
                    body: formData // Browser sets Content-Type to multipart
                });

                if (res.ok) {
                    showToast('Report Saved!', 'success');
                    closeModal('report-modal');
                    loadAppointments('today'); // Refresh
                } else {
                    const err = await res.json();
                    showToast('Error: ' + (err.error || 'Failed'), 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('Network Error', 'error');
            }
        }

        init();
    </script>
</body>

</html>